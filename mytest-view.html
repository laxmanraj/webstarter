<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="mytest-view">

  <template>
    <style></style>
	<div>
	
		<!-- <iron-ajax
			 auto 
			 url="/downloads/C001.json",
			 handleAs="json"
			 last-response="{{resp}}">
		</iron-ajax>	   -->
        <textarea rows="10" cols="100" value="{{jsonResp}}">
		</textarea>

	<!-- <paper-button raised class = "green" onclick="exportDataFeature(this)">Save</paper-button>
	<button id="exportBtn" class="btn btn--primary csv-export-btn" hidden> -->
    <paper-button on-tap="_readJsonButton" >Read</paper-button>
	<paper-button on-tap="_exportSaveButton" >Save</paper-button>
	</div>
	<iron-ajax id="jsonRespAjax1"></iron-ajax>
	</template>
  
  <script>
    Polymer({
      is: 'mytest-view',
      properties: {
		jsonResp: { 
			type: Object 
		}
	  },
	  
	  
	  /* _jsonResponse: function(request) {
	 
	  }, */
	  
	_exportSaveButton: function() {
		//window.open('/downloads/C001.csv', '_self');
		console.log(this.jsonResp);
		//var csvContent = "data:text/csv;charset=utf-8,";
		var trendData = this.jsonResp.result.trendData;
		console.log(trendData);
		var dataString = '';
		
		var json = this.jsonResp.result.trendData;
		
		var allPropsJson = this.jsonResp.result;
		
		/*var fields = [];
		
		fields.push('Date');*/
		var allPropNames = json.map(a => a.tag_name)
		
		var csvHeaders = [];
		csvHeaders.push('Date');
		
		csvHeaders.push.apply(csvHeaders, allPropNames);
		csvHeaders.push('C/H/W');
		csvHeaders.push('Label');
		
		console.log(csvHeaders);

		var myArray = ['b', 1, 'b', 2, '1'];

		var unique = myArray.filter((v, i, a) => a.indexOf(v) === i);		
		
		console.log(unique);
		
		var fields = Object.keys(json[0])
		var replacer = function(key, value) { return value === null ? '' : value } 
		var csv = json.map(function(row){
		  return fields.map(function(fieldName){
			return JSON.stringify(row[fieldName], replacer)
		  }).join(',')
		})
		csv.unshift(fields.join(',')) // add header column

		console.log(csv.join('\r\n'))
		
		
		 /*trendData.forEach(function(row, index){
			dataString = row.join(",");
			csvContent += index < trendData.length ? dataString+ "\n" : dataString;
		  });*/
		var csvContent = "data:text/csv;charset=utf-8," + csv;
		var encodedUri = encodeURI(csvContent);
		 
		  
		var link = document.createElement("a");
		link.setAttribute("href", encodedUri);
		link.setAttribute("download", "my_data.csv");
		document.body.appendChild(link); // Required for FF

		link.click(); // This will download the data file named "my_data.csv".
		  
	},	
	_readJsonButton: function() {		
		this.$.jsonRespAjax1.url = "/downloads/C001.json";
        this.$.jsonRespAjax1.generateRequest();
		console.log(this.jsonObj);
	},	
      
      ready: function () {
        var that = this;
		this.jsonObj = {};
		this.$.jsonRespAjax1.addEventListener('response', function (evt) {
          this.jsonResp = JSON.parse(JSON.stringify(evt.detail.response));		  
        }.bind(this));
		//this.resp = JSON.stringify(this.resp);
		
		  // Format for CSV
		  /* var csvContent = "data:text/csv;charset=utf-8,";
		  poly.exportData.forEach(function(row, index){
			dataString = row.join(",");
			csvContent += index < poly.exportData.length ? dataString+ "\n" : dataString;
		  });
		  var encodedUri = encodeURI(csvContent);
		  // Download CSV
		  sender.setAttribute("href", encodedUri);
		  sender.setAttribute("download", poly.filename+poly.exportTime+".csv");
		  sender.click(); */

      }
	  
    });
  </script>
</dom-module>